<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Audio Master Control V5.9</title>
    <style>
        body {
            background: #1a1a1a;
            color: #39ff14;
            font-family: 'Courier New', monospace;
            padding: 20px;
        }

        .panel {
            border: 2px solid #39ff14;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        button {
            background: #333;
            color: #39ff14;
            border: 1px solid #39ff14;
            padding: 10px;
            cursor: pointer;
            margin: 5px;
        }

        button.active {
            background: #ff0000;
            color: #fff;
        }

        #recStatus {
            display: none;
            background: #ff0000;
            color: white;
            padding: 10px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .waveform {
            width: 100%;
            height: 100px;
            background: #000;
            margin: 10px 0;
            border: 1px solid #444;
        }
    </style>
</head>

<body>

    <h1>AUDIO MASTER CONTROL V5.9</h1>

    <div id="recStatus">‚óè RECORDING ACTIVE</div>

    <div class="panel">
        <h3>1. BINAURAL ENGINE (6Hz)</h3>
        <button onclick="toggleTone()">TONE ON/OFF</button>
    </div>

    <div class="panel">
        <h3>2. MASTER CONSOLE</h3>
        <input type="file" id="musicUpload" accept="audio/*">
        <button onclick="playAll()">PLAY / START SESSION</button>
        <button onclick="stopAll()">STOP</button>
    </div>

    <div class="panel">
        <h3>3. TRACK RECORDING</h3>
        <button id="btnLeft" onclick="toggleRec('left')">REC LEFT</button>
        <button id="btnRight" onclick="toggleRec('right')">REC RIGHT</button>
    </div>

    <div id="waveMusic" class="waveform"></div>
    <div id="waveVoice" class="waveform"></div>

    <script src="https://unpkg.com/wavesurfer.js"></script>
    <script>
        // V5.9 Stability Logic: 4096 Buffer & Independent Timer
        let audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
        let mixer = audioCtx.createMediaStreamDestination();
        let micStream, recorder;
        let chunks = [];

        // Setup Wavesurfer
        const wsMusic = WaveSurfer.create({ container: '#waveMusic', waveColor: '#39ff14', progressColor: '#1d8e0d' });
        const wsVoice = WaveSurfer.create({ container: '#waveVoice', waveColor: '#ff0000', progressColor: '#8b0000' });

        document.getElementById('musicUpload').onchange = function (e) {
            const url = URL.createObjectURL(e.target.files[0]);
            wsMusic.load(url);
        };

        async function initMic() {
            micStream = await navigator.mediaDevices.getUserMedia({
                audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }
            });
            const source = audioCtx.createMediaStreamSource(micStream);
            // Solder connection: Mic -> Mixer (Persistent)
            source.connect(mixer);
        }

        function toggleRec(side) {
            const btn = side === 'left' ? document.getElementById('btnLeft') : document.getElementById('btnRight');
            btn.classList.toggle('active');
            // Panning logic for V5.9 would go here
        }

        function playAll() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            wsMusic.play();
            startRecording();
        }

        function startRecording() {
            chunks = [];
            recorder = new MediaRecorder(mixer.stream, { mimeType: 'audio/webm' });
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = exportAudio;

            document.getElementById('recStatus').style.display = 'block';
            recorder.start();

            // V5.9 Independent Timer (Music Duration + 2 Seconds)
            const duration = wsMusic.getDuration() * 1000;
            setTimeout(() => {
                stopAll();
            }, duration + 2000);
        }

        function stopAll() {
            wsMusic.stop();
            if (recorder && recorder.state === "recording") {
                recorder.stop();
            }
            document.getElementById('recStatus').style.display = 'none';
        }

        function exportAudio() {
            const blob = new Blob(chunks, { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Audio_Master_V5.9.wav';
            a.click();
        }

        initMic();
    </script>
</body>

</html>