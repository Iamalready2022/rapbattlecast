<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Aiken Laboratory - Command Console</title>
    <style>
        body {
            background: #0a0a0a;
            color: #00ff41;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .console-box {
            border: 2px solid #00ff41;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 1200px;
            box-shadow: 0 0 20px #00ff4133;
        }

        h1 {
            text-align: center;
            font-size: 2.5em;
            text-transform: uppercase;
            letter-spacing: 5px;
        }

        /* Large high-contrast controls for 32" Monitor */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        button {
            background: #00ff41;
            color: #000;
            border: none;
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            text-transform: uppercase;
        }

        button:hover {
            background: #00cc33;
            box-shadow: 0 0 15px #00ff41;
        }

        button.recording {
            background: #ff0000;
            color: #fff;
            animation: pulse 1s infinite;
        }

        .slider-group {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #333;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: #fff;
        }

        input[type="range"] {
            width: 100%;
            cursor: pointer;
            accent-color: #00ff41;
        }

        #waveforms {
            width: 100%;
            margin-top: 20px;
        }

        .track-label {
            margin-top: 10px;
            color: #888;
            font-size: 0.9em;
        }

        canvas {
            background: #000;
            border: 1px solid #00ff4155;
            width: 100%;
            height: 120px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        #security-log {
            width: 100%;
            height: 150px;
            background: #000;
            color: #00ff41;
            border: 1px solid #00ff41;
            padding: 10px;
            margin-top: 20px;
            font-family: monospace;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>

    <div class="console-box">
        <h1>Observer Command Console</h1>

        <div class="controls">
            <button id="loadBtn">Load Track 1 (Light)</button>
            <button id="syncPlayBtn">Sync Play / Pause</button>
            <button id="recordBtn">Record Track 2 (Voice)</button>
            <button id="mergeBtn" style="background: #ffd700;">Merge & Download Master</button>
        </div>

        <div class="controls">
            <div class="slider-group">
                <label>Binaural Frequency (6Hz Target)</label>
                <input type="range" id="freqSlider" min="60" max="600" value="100">
                <span id="freqLabel">100Hz / 106Hz</span>
            </div>
            <div class="slider-group">
                <label>Binaural Volume (Kill Hum Here)</label>
                <input type="range" id="binauralGain" min="0" max="0.5" step="0.01" value="0">
            </div>
        </div>

        <div id="waveforms">
            <div class="track-label">TRACK 1: MUSIC / LIGHT</div>
            <canvas id="canvas1"></canvas>
            <div class="track-label">TRACK 2: OBSERVER VOICE</div>
            <canvas id="canvas2"></canvas>
        </div>

        <textarea id="security-log"
            placeholder="SECURITY LOG: Enter session notes (164 lbs, Fasting hours, White Light session stats)..."></textarea>
        <button onclick="saveLog()" style="margin-top:10px; font-size: 0.8em; padding: 10px;">Save Log to
            LocalStorage</button>
    </div>

    <script>
        let audioCtx, track1Buffer, track2Blob, track1Source;
        let osc1, osc2, binauralGainNode;
        let isPlaying = false;
        let isRecording = false;
        let mediaRecorder;
        let recordedChunks = [];
        let startTime = 0;
        let pausedTime = 0;

        const syncPlayBtn = document.getElementById('syncPlayBtn');
        const binauralGainSlider = document.getElementById('binauralGain');
        const logArea = document.getElementById('security-log');

        // Initialize Audio Context on click
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                setupBinaural();
            }
        }

        function setupBinaural() {
            osc1 = audioCtx.createOscillator();
            osc2 = audioCtx.createOscillator();
            binauralGainNode = audioCtx.createGain();
            binauralGainNode.gain.value = 0; // Starts at 0 to kill the hum

            const panner1 = audioCtx.createStereoPanner();
            const panner2 = audioCtx.createStereoPanner();
            panner1.pan.value = -1;
            panner2.pan.value = 1;

            osc1.connect(panner1).connect(binauralGainNode);
            osc2.connect(panner2).connect(binauralGainNode);
            binauralGainNode.connect(audioCtx.destination);

            osc1.start();
            osc2.start();
            updateFrequencies();
        }

        function updateFrequencies() {
            const baseFreq = parseInt(document.getElementById('freqSlider').value);
            osc1.frequency.value = baseFreq;
            osc2.frequency.value = baseFreq + 6; // The 6Hz Theta Offset
            document.getElementById('freqLabel').innerText = `${baseFreq}Hz / ${baseFreq + 6}Hz`;
        }

        document.getElementById('freqSlider').oninput = updateFrequencies;
        binauralGainSlider.oninput = (e) => { binauralGainNode.gain.value = e.target.value; };

        // File Loading
        document.getElementById('loadBtn').onclick = async () => {
            initAudio();
            const [fileHandle] = await window.showOpenFilePicker();
            const file = await fileHandle.getFile();
            const arrayBuffer = await file.arrayBuffer();
            track1Buffer = await audioCtx.decodeAudioData(arrayBuffer);
            alert("Track 1 Loaded & Synced");
        };

        // SYNC PLAYBACK LOGIC
        syncPlayBtn.onclick = () => {
            if (!audioCtx || !track1Buffer) return alert("Load Track 1 First");

            if (isPlaying) {
                track1Source.stop();
                pausedTime += audioCtx.currentTime - startTime;
                isPlaying = false;
                syncPlayBtn.innerText = "Sync Play";
            } else {
                track1Source = audioCtx.createBufferSource();
                track1Source.buffer = track1Buffer;
                track1Source.connect(audioCtx.destination);

                startTime = audioCtx.currentTime;
                track1Source.start(0, pausedTime % track1Buffer.duration);
                isPlaying = true;
                syncPlayBtn.innerText = "Sync Stop";
            }
        };

        // Recording Logic
        document.getElementById('recordBtn').onclick = async () => {
            initAudio();
            if (!isRecording) {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, autoGainControl: false, noiseSuppression: false } });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    track2Blob = new Blob(recordedChunks, { type: 'audio/wav' });
                    alert("Voice Captured");
                };
                recordedChunks = [];
                mediaRecorder.start();
                isRecording = true;
                document.getElementById('recordBtn').classList.add('recording');
                document.getElementById('recordBtn').innerText = "Stop Recording";
            } else {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('recordBtn').classList.remove('recording');
                document.getElementById('recordBtn').innerText = "Record Track 2";
            }
        };

        // Placeholder for Merge logic - will trigger download
        document.getElementById('mergeBtn').onclick = () => {
            if (!track2Blob) return alert("Record Track 2 First");
            const url = URL.createObjectURL(track2Blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "Aiken_Master_JuneM5.wav";
            a.click();
        };

        function saveLog() {
            localStorage.setItem('aikenSecurityLog', logArea.value);
            alert("Log Saved to LocalStorage");
        }

        // Load log on start
        window.onload = () => {
            logArea.value = localStorage.getItem('aikenSecurityLog') || "";
        };
    </script>

</body>

</html>